server:
  port: 8086

spring:
  application:
    name: gateway-service
  profiles:
    active: dev
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-wait: -1ms
          max-idle: 8
          min-idle: 0
  cloud:
    compatibility-verifier:
      enabled: false
    gateway:
      globalcors:
        cors-configurations:
          "[/**]":
            allowed-origin-patterns: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600
      # HTTP Client Timeout Configuration (applied globally)
      httpclient:
        connect-timeout: 3000 # 3 seconds connection timeout
        response-timeout: 3000 # 3 seconds response timeout (lowered for timeout testing)
      routes:
        # User Service API
        - id: user-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/**
          filters:
            - name: CircuitBreaker
              args:
                name: userServiceCircuitBreaker
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000 # 5 seconds per route timeout

        # Product Service API
        - id: product-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/products/**, /api/categories/**, /api/reviews/**, /api/tags/**, /api/auth-test/**, /api/health/**, /api/test/**
          filters:
            - name: CircuitBreaker
              args:
                name: productServiceCircuitBreaker
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        # Cart service API
        - id: cart-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/cart/**, /api/actuator
          filters:
            - name: CircuitBreaker
              args:
                name: cartServiceCircuitBreaker
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        # Order service API
        - id: order-service
          uri: http://localhost:8085
          predicates:
            - Path=/api/orders/**, /api/actuator
          filters:
            - name: CircuitBreaker
              args:
                name: orderServiceCircuitBreaker
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        # Gateway Swagger UI (main entry point)
        - id: gateway-swagger-ui
          uri: http://localhost:8086
          predicates:
            - Path=/swagger-ui/**, /swagger-ui.html
          filters:
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 300ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 100000

        # Swagger UI Proxies
        - id: swagger-user-service
          uri: http://localhost:8081
          predicates:
            - Path=/swagger-user/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-user-api-docs
          uri: http://localhost:8081
          predicates:
            - Path=/swagger-user/v3/api-docs
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-notification-service
          uri: http://localhost:8082
          predicates:
            - Path=/swagger/notification/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-notification-api-docs
          uri: http://localhost:8082
          predicates:
            - Path=/swagger/notification/v3/api-docs
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-product-service
          uri: http://localhost:8083
          predicates:
            - Path=/swagger/product/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-product-api-docs
          uri: http://localhost:8083
          predicates:
            - Path=/swagger/product/v3/api-docs
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-cart-service
          uri: http://localhost:8084
          predicates:
            - Path=/swagger/cart/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-cart-api-docs
          uri: http://localhost:8084
          predicates:
            - Path=/swagger/cart/v3/api-docs
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

        - id: swagger-order-service
          uri: http://localhost:8085
          predicates:
            - Path=/swagger/order/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 10000

        - id: swagger-order-api-docs
          uri: http://localhost:8085
          predicates:
            - Path=/swagger/order/v3/api-docs
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT,SERVICE_UNAVAILABLE
                methods: GET
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false
          metadata:
            response-timeout: 5000

# Management Endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,circuitbreakers,circuitbreakerevents
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
  circuitbreaker:
    metrics:
      enabled: true

# Swagger/OpenAPI Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    urls:
      - url: /swagger-user/v3/api-docs
        name: User Service
      - url: /swagger/notification/v3/api-docs
        name: Notification Service
      - url: /swagger/product/v3/api-docs
        name: Product Service
      - url: /swagger/cart/v3/api-docs
        name: Cart Service
      - url: /swagger/order/v3/api-docs
        name: Order Service

info:
  app:
    name: Gateway Service
    version: 1.0.0

# JWT settings (same across environments)
jwt:
  secret: ${JWT_SECRET:uP9hT8bQZ3rWn2xJv5sM0aE1dL6kC9yRj7fG4uH2tN8pB5cS0xA1zM3wQ6rV9dJ2}
  expMinutes: 43200

# Gateway configuration
gateway:
  public-paths:
    - /swagger-ui
    - /swagger-ui.html
    - /v3/api-docs
    - /swagger
    - /swagger-user
    - /swagger-product
    - /swagger-cart
    - /swagger-order
    - /swagger-notification
    - /actuator/health
    - /actuator/info
    - /api/users/auth/login
    - /api/users/auth/register
    - /api/varify/email
    - /api/varify/request-otp
    - /api/products/list
    - /api/categories
    - /api/reviews
    - /api/tags
    - /api/health
    - /api/test
    - /api/auth-test
    - /api/cart/actuator
    - /api/orders/actuator
    - /bff/auth/login
    - /bff/products
  rate-limiting:
    requests-per-minute: 10
    requests-per-hour: 1000
    excluded-paths:
      - /actuator/health
      - /swagger-ui
      - /v3/api-docs
      - /swagger
      - /health
      - /api/health
  locale:
    default-language: en
  role-based-paths:
    ADMIN:
      - /api/admin
      - /api/users/admin
      - /api/orders/admin
      - /api/products/admin
      - /api/cart/admin
      - /api/notifications/admin
    USER:
      - /api/users/me
      - /api/users/update
      - /api/orders
      - /api/cart
      - /api/products/review
    PUBLIC:
      - /api/users/auth/login
      - /api/users/auth/register
      - /api/products/list
      - /api/categories
      - /api/reviews
      - /api/tags
      - /api/health
      - /api/test
      - /api/auth-test
      - /swagger
      - /v3/api-docs
      - /actuator
      - /webjars
      - /favicon.ico

logging:
  level:
    org.springframework.cloud.gateway.filter.factory.RetryGatewayFilterFactory: DEBUG
    io.github.resilience4j.circuitbreaker: INFO
    org.springframework.cloud.circuitbreaker: DEBUG

# Resilience4j Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - org.springframework.web.reactive.function.client.WebClientException
          - java.util.concurrent.TimeoutException
          - java.net.ConnectException
      userServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
      productServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
      cartServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50
      orderServiceCircuitBreaker:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s
        failureRateThreshold: 50

# BFF service base URLs (override per environment)
bff:
  services:
    userBaseUrl: http://localhost:8081
    productBaseUrl: http://localhost:8083
    cartBaseUrl: http://localhost:8084
    orderBaseUrl: http://localhost:8085
